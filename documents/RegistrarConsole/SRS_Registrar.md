# 要件定義書 (SRS) — Registrar Console  
**zk‑CertFramework / 学務管理システム** 最終更新: 2025-08-09 (Version 2.4)

## 1. 目的  
Registrar Console は学務職員が **Tauri デスクトップアプリ** として、①書類所有者 Passkey 公開鍵の年度別管理、②**QR コードスキャンによる効率的なデータ収集**、③Poseidon Merkle Tree 構築、④PDF/A-3 証明書の一括生成を**完全ローカル環境**で実行する。**Trust Minimized 設計**により外部データベース・API依存を排除し、**年度別独立データ管理**により簡潔かつ監査可能な運用を実現する。

## 2. スコープ  
| 区分 | 含む | 含まない |
|------|------|----------|
| **データ管理** | 年度別学生データ・JSONファイル管理・QRスキャン収集 | 外部データベース・クラウドストレージ |
| **QR スキャン** | **デバイスカメラ統合・リアルタイム QR 認識・重複検出** | **外部 QR 処理サービス・画像アップロード** |
| **Merkle Tree** | Poseidon ハッシュ・depth=8固定構築 | カスタムハッシュ・動的depth設定 |
| **PDF生成** | PDF/A-3バッチ生成・テンプレート | 動的レイアウト・電子署名・暗号化 |
| **アプリ形態** | Tauri デスクトップ・オフライン完結 | Web アプリ・サーバークライアント |
| **セキュリティ** | ローカル暗号化・ファイルレベル権限・カメラプライバシー | ネットワーク認証・集中認可サーバー |

## 3. 用語
| 用語 | 定義 |
|------|------|
| **Passkey** | WebAuthn COSE_Key 形式の学生公開鍵 |
| **Commit** | Poseidon(PublicKey) による学生識別子 |
| **Merkle Tree** | Poseidon ハッシュ・depth=8・256葉の完全バランス木 |
| **年度独立** | 年度毎の完全分離データ・共有状態なし |
| **QR スキャン** | **WebRTC + jsQR による リアルタイム QR コード認識** |
| **収集セッション** | **QR スキャンによる 時間限定データ収集プロセス** |

## 4. ステークホルダ・アクター
| アクター | 主要関心事 | システム期待 |
|----------|------------|--------------|
| **学務職員** | 学生データの正確・効率的管理・QR 収集の簡便性 | 直感的操作・エラー防止・高速処理・リアルタイム フィードバック |
| **学部事務** | 年度切替・データ移行作業 | 年度別明確分離・簡単バックアップ |
| **システム管理者** | 運用安定性・セキュリティ確保・カメラプライバシー | ローカル完結・監査証跡・障害対策・プライバシー保護 |
| **学生 (間接)** | 証明書の正確性・可用性・QR 提示の簡単さ | 常時利用可能な Merkle Root・PDF品質・快適な QR 体験 |

## 5. ユースケース詳細
### 5.1 UC‑RC‑01: 年度別学生データインポート
- **主アクター**: 学務職員
- **前提条件**: Scholar Prover で収集済み Passkey データ
- **基本フロー**:
  1. 年度選択 (例: 2025年度)
  2. JSON/CSV ファイル選択・アップロード
  3. データ形式・重複検証の自動実行
  4. インポート結果プレビュー・エラー確認
  5. 確認後、document-owners-2025.json に保存
  6. 自動バックアップ・操作ログ記録
- **成功条件**: 正確な年度別学生データの保存完了
- **例外フロー**: 
  - E1. 重複データ検出 → 重複一覧表示・手動解決
  - E2. 無効な Passkey 形式 → エラー詳細・修正ガイド

### 5.2 UC‑RC‑02: QR コード収集セッション
- **主アクター**: 学務職員
- **前提条件**: カメラアクセス可能・対象年度選択済み
- **基本フロー**:
  1. QR 収集モード開始・セッション名設定
  2. カメラ初期化・スキャナーUI 表示
  3. 学生による QR コード提示
  4. リアルタイム QR スキャン・デコード
  5. データ検証・重複チェック・整合性確認
  6. 有効データの収集バッファ追加
  7. 成功フィードバック・進捗更新
  8. 全学生スキャン完了後セッション終了
  9. owners-{year}.json への一括保存
- **成功条件**: 全学生の Passkey データ収集完了
- **例外フロー**:
  - E1. カメラアクセス拒否 → 代替手段案内
  - E2. QR 読取り失敗 → 再スキャン案内
  - E3. 重複 QR 検出 → スキップ・警告表示
  - E4. 無効な QR 形式 → エラー詳細・形式確認

### 5.3 UC‑RC‑03: Poseidon Merkle Tree 構築
- **主アクター**: 学務職員  
- **前提条件**: 年度別学生データ登録完了
- **基本フロー**:
  1. 対象年度の学生データ読込み
  2. 各学生 Passkey から Poseidon Commit 計算
  3. depth=8 (256葉) Merkle Tree 構築
  4. ゼロパディング・バランス調整
  5. Merkle Root 計算・検証
  6. merkle-2025.json に Tree データ保存
  7. Merkle Root の Executive Console への提供
- **成功条件**: 検証可能な Merkle Tree・Root の生成

### 5.4 UC‑RC‑04: PDF/A-3 証明書バッチ生成
- **主アクター**: 学務職員
- **前提条件**: Merkle Tree 構築完了・証明書テンプレート準備
- **基本フロー**:
  1. 証明書テンプレート選択・カスタマイズ
  2. 年度別学生データの読込み・確認
  3. 全学生分の PDF/A-3 並列生成
  4. プログレス表示・リアルタイム進捗更新
  5. 個別PDFファイルの検証・品質チェック
  6. 生成結果レポート・エラー詳細表示
  7. ~/generated/pdfs-2025/ フォルダに保存
- **成功条件**: 全学生分の高品質 PDF/A-3 証明書生成

## 6. 機能要求
| FR ID | 要求 | 検証基準 |
|-------|------|----------|
| **FR‑RC‑01** | Tauri デスクトップアプリ・単一実行ファイル | Windows/macOS/Linux 配布・インストーラー不要 |
| **FR‑RC‑02** | 年度別書類所有者データの JSON 形式管理 | document-owners-{year}.json スキーマ準拠 |
| **FR‑RC‑03** | COSE_Key 形式 Passkey データの検証・インポート | WebAuthn COSE_Key 仕様準拠・形式チェック |
| **FR‑RC‑04** | Poseidon ハッシュ Merkle Tree (depth=8) 構築 | @noble/hashes 使用・256葉固定 |
| **FR‑RC‑05** | PDF/A-3 証明書テンプレート・バッチ生成 | ISO 19005-3 準拠・Adobe Reader 対応 |
| **FR‑RC‑06** | ローカルファイル暗号化・バックアップ管理 | AES-256・USB バックアップ機能 |
| **FR‑RC‑07** | データ整合性検証・重複検出機能 | SHA-3 ハッシュ・自動重複解決 |
| **FR‑RC‑08** | **デバイスカメラ統合・WebRTC アクセス** | **カメラ許可・ストリーム取得・1280x720 対応** |
| **FR‑RC‑09** | **リアルタイム QR コード認識・jsQR 統合** | **10fps スキャン・500ms 応答・M レベル訂正** |
| **FR‑RC‑10** | **QR データ検証・重複検出・整合性チェック** | **SHA-3 チェックサム検証・学生 ID 重複防止** |
| **FR‑RC‑11** | **QR 収集セッション管理・進捗追跡** | **セッション開始/終了・リアルタイム カウンタ** |
| **FR‑RC‑12** | **カメラプライバシー保護・ローカル処理** | **画像保存禁止・ネットワーク送信ゼロ** |

## 7. 非機能要求
| NFR ID | カテゴリ | 指標 | 目標 | 測定方法 |
|--------|----------|------|------|----------|
| **NFR‑RC‑P1** | パフォーマンス | Merkle Tree 構築時間 | ≤ 10秒 @ 256学生 | Poseidon ハッシュ・実機測定 |
| **NFR‑RC‑P2** | パフォーマンス | PDF バッチ生成時間 | ≤ 2分 @ 256学生 | 並列処理・実機測定 |
| **NFR‑RC‑P3** | パフォーマンス | アプリ起動時間 | ≤ 2秒 | Tauri 冷起動 |
| **NFR‑RC‑P4** | **パフォーマンス** | **QR スキャン応答時間** | **≤ 500ms** | **jsQR 処理時間** |
| **NFR‑RC‑P5** | **パフォーマンス** | **カメラ初期化時間** | **≤ 2秒** | **WebRTC 接続時間** |
| **NFR‑RC‑S1** | セキュリティ | ローカルデータ暗号化 | AES-256 | ファイルレベル暗号化 |
| **NFR‑RC‑S2** | セキュリティ | 外部ネットワーク通信 | 0件 | 完全ローカル完結 |
| **NFR‑RC‑S3** | **セキュリティ** | **カメラデータ保護** | **メモリ処理のみ** | **画像ファイル保存ゼロ** |
| **NFR‑RC‑R1** | 信頼性 | データ整合性保証 | 100% | ハッシュチェーン検証 |
| **NFR‑RC‑R2** | 信頼性 | 年度データ独立性 | 100% | 年度間共有状態ゼロ |
| **NFR‑RC‑R3** | **信頼性** | **QR 読取り成功率** | **≥ 95%** | **正常照明条件** |
| **NFR‑RC‑U1** | ユーザビリティ | 操作成功率 | ≥ 95% | 初回ユーザータスク完了 |
| **NFR‑RC‑U2** | **ユーザビリティ** | **QR 収集効率** | **≥ 100 学生/時間** | **実運用測定** |
| **NFR‑RC‑M1** | 保守性 | バックアップ・復元 | 完全 | ワンクリック・USB対応 |

## 8. QR コード収集要求
### 8.1 カメラ統合要求
- **CAM‑01**: WebRTC による デバイスカメラアクセス
- **CAM‑02**: 1280x720 以上の解像度対応
- **CAM‑03**: 30fps カメラストリーム取得
- **CAM‑04**: 複数カメラデバイス選択機能
- **CAM‑05**: カメラ設定（明度・コントラスト）調整
- **CAM‑06**: カメラアクセス許可の適切な処理

### 8.2 QR 認識要求
- **QR‑01**: jsQR ライブラリによる リアルタイム認識
- **QR‑02**: 10fps でのフレーム処理
- **QR‑03**: QR Code 2005 (ISO/IEC 18004) 対応
- **QR‑04**: エラー訂正レベル M (15%) 対応
- **QR‑05**: UTF-8 JSON データ デコード
- **QR‑06**: 認識失敗時の自動リトライ

### 8.3 データ検証要求
- **VAL‑01**: JSON スキーマ検証（version 2.4）
- **VAL‑02**: SHA-3 チェックサム整合性確認
- **VAL‑03**: 学生 ID 重複検出・防止
- **VAL‑04**: 年度一致性チェック
- **VAL‑05**: Passkey 形式検証（COSE_Key）
- **VAL‑06**: タイムスタンプ有効性確認

## 9. データ要求
### 9.1 書類所有者データスキーマ (document-owners-{year}.json)
```json
{
  "version": "2.2",
  "year": 2025,
  "lastUpdated": 1704067200000,
  "collectionMethod": "qr_scan",
  "qrSessionId": "uuid-v4",
  "documentOwners": [
    {
      "id": "2025001",
      "name": "田中太郎",
      "email": "tanaka@university.edu",
      "passkey": {
        "publicKey": "pQECAyYgASFYIBwf...rKjY",
        "credentialId": "AQIDBAUGBwgJ...",
        "algorithm": -7
      },
      "commit": "0x1a2b3c4d...",
      "merkleIndex": 0,
      "registrationDate": 1704067200000,
      "qrScanData": {
        "scannedAt": 1704067200000,
        "sessionId": "uuid-v4",
        "checksum": "sha3-512-hash",
        "scanDuration": 1500
      }
    }
  ],
  "statistics": {
    "totalDocumentOwners": 1,
    "merkleRoot": "0xabcd1234...",
    "merkleDepth": 8
  }
}
```

### 9.2 QR 収集セッション (qr-session-{uuid}.json)
```json
{
  "sessionId": "uuid-v4",
  "year": 2025,
  "startTime": 1704067200000,
  "endTime": 1704070800000,
  "status": "completed",
  "operator": "学務太郎",
  "cameraConfig": {
    "deviceId": "camera-device-id",
    "resolution": "1280x720",
    "frameRate": 30
  },
  "statistics": {
    "totalScanned": 150,
    "successful": 148,
    "duplicates": 2,
    "errors": 0,
    "scanRate": 98.7,
    "avgScanTime": 1200
  },
  "scannedStudents": [
    {
      "studentId": "2025001",
      "name": "田中太郎",
      "scannedAt": 1704067200000,
      "scanDuration": 1500,
      "qrDataHash": "sha3-hash",
      "status": "success"
    }
  ],
  "errors": [
    {
      "timestamp": 1704067250000,
      "error": "QR_DECODE_FAILED",
      "rawData": "corrupted-qr-data",
      "action": "skipped"
    }
  ],
  "duplicates": [
    {
      "studentId": "2025002",
      "firstScanAt": 1704067300000,
      "duplicateScanAt": 1704067400000,
      "action": "skipped_duplicate"
    }
  ]
}
```

## 10. セキュリティ要求
### 10.1 ローカルセキュリティ
- **SEC‑01**: **ファイル暗号化**: 学生データの AES-256 暗号化
- **SEC‑02**: **アクセス制御**: OS ファイルシステム権限による保護
- **SEC‑03**: **監査ログ**: 全操作の改竄検知付きローカルログ
- **SEC‑04**: **データ検証**: インポート時の厳格な形式・整合性チェック

### 10.2 カメラ・プライバシー保護
- **SEC‑05**: **ローカル処理**: QR スキャンデータの外部送信禁止
- **SEC‑06**: **画像非保存**: カメラフレームのディスク保存禁止
- **SEC‑07**: **メモリ処理**: QR 認識処理はメモリ上のみ実行
- **SEC‑08**: **セッション管理**: 収集セッション終了時の確実なクリーンアップ
- **SEC‑09**: **最小権限**: カメラアクセスの必要最小限使用
- **SEC‑10**: **透明性**: QR 収集プロセスの完全な可視化

### 10.3 Trust Minimization
- **SEC‑11**: **外部依存排除**: データベース・クラウド・API 使用禁止
- **SEC‑12**: **検証可能性**: 全処理結果の暗号学的検証
- **SEC‑13**: **透明性**: オープンソース・監査可能な実装
- **SEC‑14**: **単一責任**: 明確な機能境界・最小攻撃面

## 11. ユーザビリティ要求
### 11.1 QR スキャン操作性
- **UX‑01**: **直感的スキャン**: カメラ映像・QR 検出エリア・明確なガイダンス
- **UX‑02**: **リアルタイム フィードバック**: スキャン成功・エラー・重複の即座な表示
- **UX‑03**: **進捗可視化**: 収集状況・残り件数・完了率のリアルタイム表示
- **UX‑04**: **エラー回復**: スキャン失敗時の明確な再試行案内

### 11.2 効率的ワークフロー
- **UX‑05**: **バッチ処理**: 全学生データの一括処理機能
- **UX‑06**: **セッション管理**: 収集セッションの開始・一時停止・再開・終了
- **UX‑07**: **自動保存**: スキャン完了時の自動データ保存
- **UX‑08**: **履歴管理**: 過去の収集セッション履歴・統計表示

## 12. Tauri アプリ要求
### 12.1 デスクトップ統合
- **DESK‑01**: **ネイティブUI**: OS 標準のファイルダイアログ・通知
- **DESK‑02**: **システム統合**: ファイル関連付け・右クリックメニュー
- **DESK‑03**: **マルチウィンドウ**: 複数年度の並行作業対応
- **DESK‑04**: **自動更新**: 署名検証付きセキュアアップデート
- **DESK‑05**: **カメラ統合**: Tauri WebRTC プラグインによるカメラアクセス

### 12.2 セキュア Tauri
- **DESK‑06**: **サンドボックス**: 適切なセキュリティ設定
- **DESK‑07**: **IPC セキュリティ**: Main・Renderer 間の安全通信
- **DESK‑08**: **CSP 適用**: Content Security Policy 厳格設定
- **DESK‑09**: **Node.js 分離**: レンダラーでの Node.js 無効化
- **DESK‑10**: **権限管理**: カメラアクセス権限の適切な制御

## 13. 受入基準
### 13.1 機能受入基準
- [ ] 全機能要求 (FR‑RC‑01 ~ FR‑RC‑12) の完全実装
- [ ] 4つの主要ユースケース (UC‑RC‑01~04) の正常動作
- [ ] 256学生データでの End-to-End テスト成功
- [ ] 年度別独立動作・データ分離の確認
- [ ] **QR コード収集セッションの完全動作**
- [ ] **カメラ統合・リアルタイム認識の成功**

### 13.2 性能受入基準
- [ ] Merkle Tree 構築 ≤ 10秒 (256学生)
- [ ] PDF バッチ生成 ≤ 2分 (256学生)
- [ ] アプリ起動時間 ≤ 3秒
- [ ] ファイル操作レスポンス ≤ 1秒
- [ ] **QR スキャン応答 ≤ 500ms**
- [ ] **カメラ初期化 ≤ 2秒**
- [ ] **収集効率 ≥ 100 学生/時間**

### 13.3 セキュリティ受入基準
- [ ] 外部ネットワーク通信 0件 確認
- [ ] ファイル暗号化・復号化 正常動作
- [ ] データ整合性検証 100% 成功
- [ ] 静的セキュリティ解析クリア
- [ ] **カメラデータ非保存 確認**
- [ ] **QR データ ローカル処理のみ確認**

### 13.4 ユーザビリティ受入基準
- [ ] 初回ユーザーのタスク完了率 ≥ 95%
- [ ] エラー回復・ガイダンス機能確認
- [ ] アクセシビリティ (WAI-ARIA) 準拠
- [ ] 多言語対応 (日本語・英語)
- [ ] **QR スキャン成功率 ≥ 95% (正常照明)**
- [ ] **QR 収集ワークフローの直感性確認**

## 14. 制約・依存関係
### 14.1 技術制約
- **Tauri**: 2.0+ (セキュリティ対応版)
- **Node.js**: 18+ LTS (Poseidon・PDF ライブラリ互換)
- **WebRTC**: カメラアクセス対応ブラウザエンジン
- **jsQR**: QR コード認識ライブラリ
- **ストレージ**: 10GB以上 (年度データ・PDF保存)
- **メモリ**: 8GB以上 (大量PDF生成・Merkle Tree処理)
- **カメラ**: 720p 以上対応デバイスカメラ

### 14.2 運用制約
- **年度切替**: 各年度開始前のデータ移行・設定更新
- **テンプレート管理**: 証明書レイアウトの年度別カスタマイズ
- **バックアップ運用**: 定期的な USB・外部ストレージ保存
- **カメラ環境**: 適切な照明条件・QR 表示品質の確保

### 14.3 法的制約
- **データ保護**: 個人情報保護法・大学規則準拠
- **文書保存**: 証明書発行記録の法定保存期間対応
- **監査要求**: 文部科学省・認証機関の監査対応
- **プライバシー**: カメラ使用に関する適切な同意取得

## 15. リスク・対策
| リスク ID | リスク内容 | 影響度 | 対策 |
|-----------|------------|--------|------|
| **R‑RC‑01** | 大量学生データ処理時のメモリ不足 | 中 | ストリーミング処理・段階的読込み |
| **R‑RC‑02** | PDF 生成ライブラリの脆弱性 | 高 | 定期更新・代替ライブラリ準備 |
| **R‑RC‑03** | ローカルファイル破損・消失 | 高 | 自動バックアップ・冗長化 |
| **R‑RC‑04** | Tauri セキュリティ問題 | 高 | 定期アップデート・セキュリティ監視 |
| **R‑RC‑05** | 年度データ移行時の操作ミス | 中 | 確認ダイアログ・操作ログ・復元機能 |
| **R‑RC‑06** | **カメラアクセス拒否・デバイス問題** | **中** | **代替手段準備・USB カメラ対応** |
| **R‑RC‑07** | **QR 読取り環境不良 (照明・角度)** | **低** | **環境ガイダンス・手動補正機能** |
| **R‑RC‑08** | **大量 QR スキャン時のパフォーマンス低下** | **中** | **バッファ管理・段階的保存** |

---

