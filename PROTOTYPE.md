# Tri-CertFramework プロトタイプの仕様
**Version 2.4 – 最終更新: 2025-08-09（更新反映: Groth16統一 / Phase0 QR回避 / Hardhat推奨）**

`documents`配下の資料はプロダクションレベルの話であり、実際に作成するアプリケーションは段階的移行対応プロトタイプになるため、以下にその違いを示す。また、以下の資料では次の用語を仕様する。
- プロダクションレベル
  - 意味: `documents`配下・資料中の仕様（Tri-CertFramework完全版）
- プロトタイプ
  - 意味: 実際に作成するアプリの仕様。`prototype-docs`配下・資料中の仕様。**段階的移行対応版**。

## 段階的移行アプローチ（現状反映）
**dev-plan準拠**: Phase 0（基盤）→ Phase 1（ブロックチェーン統合）→ Phase 2（完全システム）の段階的構築により、学習効率とリスク軽減を実現する。

### Phase 0: 基盤システム
- **システム**: Scholar Prover + Verifier UI
- **VK取得**: ローカルファイル選択（基本機能）
- **電子署名**: WebAuthn（ES256）アサーション方式を採用（JWS ではなく、`webauthn_sig.json` と `webauthn_pub.jwk.json` をPDFに埋め込み）
- **QRエクスポート**: 電子署名方式により Phase 0 では不要（回避）
- **目標**: 基本概念の実証・早期成功体験

### Phase 1: ブロックチェーン統合（ネットワーク方針更新）
- **システム**: + Executive Console
- **VK取得**: ブロックチェーン取得（拡張機能）
- **目標**: Trust Minimized設計の実感
  
  実装ネットワークはデフォルトで **Hardhat/Hardhat Network（ローカル）** を利用し、ガスやテストETH入手の制約を回避する。zkEVM Cardona はオプション（後段の公開デモ/比較用）。

### Phase 2: 完全システム
- **システム**: + Registrar Console（4システム完全統合）
- **VK取得**: ハイブリッド（フォールバック機能）
- **目標**: 教授向け完全デモンストレーション

## ZKP回路ファイルの配布方法（Groth16統一）
|対象|プロダクションレベル|プロトタイプ|
|:-:|:-:|:-:|
|検証鍵（以下VK）|特定のURLにアクセスしダウンロード|**段階的VK取得**: ローカルファイル選択 → Polygon zkEVM上に直接保存 → ハイブリッド|
|証明回路ファイル|IPFSなどで配布|GitHub Releases経由で配布|

### 詳細
- **Phase 0**: ローカルVKファイル選択による基本的なZKP機能確認
- **Phase 1**: Executive ConsoleがVKManager.solをデプロイし、VKのJSONデータ自体を文字列またはバイト配列として、スマートコントラクトのストレージに直接保存する。
- この際、VKのハッシュ値（vkHash）も別途コントラクトに保存し、UI側で取得したVKとハッシュ値が一致するか検証する。
- **Phase 2**: 検証者システム (Verifier UI) は、ブロックチェーン（Polygon zkEVM）から直接、VKデータを取得する。ハイブリッドモードでは、ブロックチェーン取得失敗時にローカルファイル選択にフォールバック。

## 管理者システム（Registrar Console）の段階的実装
- **Phase 0**: 実装対象外（基本概念に集中）
- **Phase 1**: 実装対象外（ブロックチェーン統合に集中）
- **Phase 2**: 「YearlySet」の概念は「年度別独立性」という重要な原則を表しますが、プロトタイプでは単一の年度（例: 2025年度）のYearlySetのみをデプロイ・運用することで十分。よって、手動でファイルに用意した**学生の検証鍵**をJSON形式で保存する。これにより、複数年度の切り替えや管理UIの複雑さを回避する。
- **検証鍵レジストリ管理**: 学生から提出された検証鍵ファイルを手動でインポートし、レジストリを構築。IPFS/GitHub公開は基本的な手動アップロード機能で実装。
- Ptauファイルの管理は複雑になりがちである。プロトタイプでは、事前に生成されたPtauファイルをExecutive Consoleの実行環境に配置し、コンパイル時にそれを参照するだけで済むようにする。

## 非機能要件の優先度調整
- 「教授の視点から動作するプロトタイプ」という目的に鑑み、厳密なパフォーマンス目標（例: ZKP生成5秒以内、検証100ms以内など）や、網羅的なエラーハンドリング、監査ログ、多言語対応、高度なアクセシビリティといったプロダクションレベルの非機能要件は、プロトタイプでは優先度を下げ、**段階的に価値を実感できる主要なデモシナリオ**がスムーズに動作することに焦点を当てる。
- Verifier UIの「完全オフライン検証（Service Worker）」は、プロジェクトの重要な特徴の一つだが、実装には手間がかかる。よって、UIにアクセスできた時点でオンラインとみなし、完全オフラインは要件に含めない。
- 署名形式は WebAuthn アサーション（ES256）で統一。Phase 0 では JWS を採用しない。

## テスト範囲の絞り込み
- 全システムの詳細なユニットテストやE2Eテストはプロダクション向けである。プロトタイプでは**段階的に教授が実際に確認する主要なユースケース**（例: Phase 0でのローカルVK選択・ZKP生成、Phase 1でのExecutive ConsoleによるVKデプロイとLedger署名、Phase 2での4システム統合）に絞って、ハッピーパス（正常系）の動作を確認する手動テストで十分。

## ブロックチェーン環境（方針更新）
開発・検証容易性とコスト回避のため、プロトタイプのデフォルトは **Hardhat + Hardhat Network**（ローカルRPC）を採用する。必要に応じて zkEVM Cardona へ切替可能（オプション）。

## MetaMask ネットワーク設定（推奨: Hardhat）

開発・デモ用（デフォルト）: Hardhat Network

| 項目 | 設定値 |
|-----|--------|
| **ネットワーク名** | Hardhat Local |
| **RPC URL** | http://127.0.0.1:8545 |
| **チェーンID** | 31337 |
| **通貨シンボル** | ETH |

オプション: Polygon zkEVM Cardona Testnet（必要時のみ）

| 項目 | 設定値 |
|-----|--------|
| **ネットワーク名** | Polygon zkEVM Cardona Testnet |
| **RPC URL** | https://rpc.cardona.zkevm-rpc.com |
| **チェーンID** | 2442 |
| **通貨シンボル** | ETH |
| **ブロックエクスプローラー** | https://cardona-zkevm.polygonscan.com/ |
| **フォーセット** | https://faucet.polygon.technology/ |
| **ブリッジUI** | https://bridge-ui.cardona.zkevm-rpc.com |

## ツールの活用方法
- GitHub PagesでVerifier UIを配布。
- Tauriアプリケーションの配布はGitHub Releasesを通じた署名付きバイナリとして行う。

## 段階的移行の利点
1. **学習効率**: 複雑性を段階的に導入し、各段階で理解を深める
2. **リスク軽減**: 各段階で問題を早期発見・修正可能
3. **早期成功体験**: Phase 0で基本機能動作確認により自信獲得
4. **柔軟性**: 各段階で方向性調整可能
5. **教授デモ価値**: 各段階で異なる価値を実感・最終的にTri-CertFramework完全システムの威力を実演
6. **三層認証体験**: Phase 2でZKP + ブロックチェーン + 電子署名の総合的なセキュリティを体感
