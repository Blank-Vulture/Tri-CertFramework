# 要件定義書 (SRS) — Registrar Console  
**zk‑CertFramework / 学務管理システム** 最終更新: 2025-06-17 (Version 2.0)

## 1. 目的  
Registrar Console は学務職員が **Tauri デスクトップアプリ** として、①書類所有者 Passkey 公開鍵の年度別管理、②Poseidon Merkle Tree 構築、③PDF/A-3 証明書の一括生成を**完全ローカル環境**で実行する。**Trust Minimized 設計**により外部データベース・API依存を排除し、**年度別独立データ管理**により簡潔かつ監査可能な運用を実現する。

## 2. スコープ  
| 区分 | 含む | 含まない |
|------|------|----------|
| **データ管理** | 年度別学生データ・JSONファイル管理 | 外部データベース・クラウドストレージ |
| **Merkle Tree** | Poseidon ハッシュ・depth=8固定構築 | カスタムハッシュ・動的depth設定 |
| **PDF生成** | PDF/A-3バッチ生成・テンプレート | 動的レイアウト・電子署名・暗号化 |
| **アプリ形態** | Tauri デスクトップ・オフライン完結 | Web アプリ・サーバークライアント |
| **セキュリティ** | ローカル暗号化・ファイルレベル権限 | ネットワーク認証・集中認可サーバー |

## 3. 用語
| 用語 | 定義 |
|------|------|
| **Passkey** | WebAuthn COSE_Key 形式の学生公開鍵 |
| **Commit** | Poseidon(PublicKey) による学生識別子 |
| **Merkle Tree** | Poseidon ハッシュ・depth=8・256葉の完全バランス木 |
| **年度独立** | 年度毎の完全分離データ・共有状態なし |

## 4. ステークホルダ・アクター
| アクター | 主要関心事 | システム期待 |
|----------|------------|--------------|
| **学務職員** | 学生データの正確・効率的管理 | 直感的操作・エラー防止・高速処理 |
| **学部事務** | 年度切替・データ移行作業 | 年度別明確分離・簡単バックアップ |
| **システム管理者** | 運用安定性・セキュリティ確保 | ローカル完結・監査証跡・障害対策 |
| **学生 (間接)** | 証明書の正確性・可用性 | 常時利用可能な Merkle Root・PDF品質 |

## 5. ユースケース詳細
### 5.1 UC‑RC‑01: 年度別学生データインポート
- **主アクター**: 学務職員
- **前提条件**: Scholar Prover で収集済み Passkey データ
- **基本フロー**:
  1. 年度選択 (例: 2025年度)
  2. JSON/CSV ファイル選択・アップロード
  3. データ形式・重複検証の自動実行
  4. インポート結果プレビュー・エラー確認
  5. 確認後、document-owners-2025.json に保存
  6. 自動バックアップ・操作ログ記録
- **成功条件**: 正確な年度別学生データの保存完了
- **例外フロー**: 
  - E1. 重複データ検出 → 重複一覧表示・手動解決
  - E2. 無効な Passkey 形式 → エラー詳細・修正ガイド

### 5.2 UC‑RC‑02: Poseidon Merkle Tree 構築
- **主アクター**: 学務職員  
- **前提条件**: 年度別学生データ登録完了
- **基本フロー**:
  1. 対象年度の学生データ読込み
  2. 各学生 Passkey から Poseidon Commit 計算
  3. depth=8 (256葉) Merkle Tree 構築
  4. ゼロパディング・バランス調整
  5. Merkle Root 計算・検証
  6. merkle-2025.json に Tree データ保存
  7. Merkle Root の Executive Console への提供
- **成功条件**: 検証可能な Merkle Tree・Root の生成

### 5.3 UC‑RC‑03: PDF/A-3 証明書バッチ生成
- **主アクター**: 学務職員
- **前提条件**: Merkle Tree 構築完了・証明書テンプレート準備
- **基本フロー**:
  1. 証明書テンプレート選択・カスタマイズ
  2. 年度別学生データの読込み・確認
  3. 全学生分の PDF/A-3 並列生成
  4. プログレス表示・リアルタイム進捗更新
  5. 個別PDFファイルの検証・品質チェック
  6. 生成結果レポート・エラー詳細表示
  7. ~/generated/pdfs-2025/ フォルダに保存
- **成功条件**: 全学生分の高品質 PDF/A-3 証明書生成

## 6. 機能要求
| FR ID | 要求 | 検証基準 |
|-------|------|----------|
| **FR‑RC‑01** | Tauri デスクトップアプリ・単一実行ファイル | Windows/macOS/Linux 配布・インストーラー不要 |
| **FR‑RC‑02** | 年度別書類所有者データの JSON 形式管理 | document-owners-{year}.json スキーマ準拠 |
| **FR‑RC‑03** | COSE_Key 形式 Passkey データの検証・インポート | WebAuthn COSE_Key 仕様準拠・形式チェック |
| **FR‑RC‑04** | Poseidon ハッシュ Merkle Tree (depth=8) 構築 | @noble/hashes 使用・256葉固定 |
| **FR‑RC‑05** | PDF/A-3 証明書テンプレート・バッチ生成 | ISO 19005-3 準拠・Adobe Reader 対応 |
| **FR‑RC‑06** | ローカルファイル暗号化・バックアップ管理 | AES-256・USB バックアップ機能 |
| **FR‑RC‑07** | データ整合性検証・重複検出機能 | SHA-3 ハッシュ・自動重複解決 |

## 7. 非機能要求
| NFR ID | カテゴリ | 指標 | 目標 | 測定方法 |
|--------|----------|------|------|----------|
| **NFR‑RC‑P1** | パフォーマンス | Merkle Tree 構築時間 | ≤ 10秒 @ 256学生 | Poseidon ハッシュ・実機測定 |
| **NFR‑RC‑P2** | パフォーマンス | PDF バッチ生成時間 | ≤ 2分 @ 256学生 | 並列処理・実機測定 |
| **NFR‑RC‑P3** | パフォーマンス | アプリ起動時間 | ≤ 2秒 | Tauri 冷起動 |
| **NFR‑RC‑S1** | セキュリティ | ローカルデータ暗号化 | AES-256 | ファイルレベル暗号化 |
| **NFR‑RC‑S2** | セキュリティ | 外部ネットワーク通信 | 0件 | 完全ローカル完結 |
| **NFR‑RC‑R1** | 信頼性 | データ整合性保証 | 100% | ハッシュチェーン検証 |
| **NFR‑RC‑R2** | 信頼性 | 年度データ独立性 | 100% | 年度間共有状態ゼロ |
| **NFR‑RC‑U1** | ユーザビリティ | 操作成功率 | ≥ 95% | 初回ユーザータスク完了 |
| **NFR‑RC‑M1** | 保守性 | バックアップ・復元 | 完全 | ワンクリック・USB対応 |

## 8. データ要求
### 8.1 書類所有者データスキーマ (document-owners-{year}.json)
```json
{
  "version": "2.0",
  "year": 2025,
  "lastUpdated": 1704067200000,
  "documentOwners": [
    {
      "id": "2025001",
      "name": "田中太郎",
      "email": "tanaka@university.edu",
      "passkey": {
        "publicKey": "pQECAyYgASFYIBwf...rKjY",
        "credentialId": "AQIDBAUGBwgJ...",
        "algorithm": -7
      },
      "commit": "0x1a2b3c4d...",
      "merkleIndex": 0,
      "registrationDate": 1704067200000
    }
  ],
  "statistics": {
    "totalDocumentOwners": 1,
    "merkleRoot": "0xabcd1234...",
    "merkleDepth": 8
  }
}
```

### 8.2 Merkle Tree スキーマ (merkle-{year}.json)
```json
{
  "version": "2.0",
  "year": 2025,
  "depth": 8,
  "totalLeaves": 256,
      "actualDocumentOwners": 1,
  "root": "0xabcd1234efgh5678...",
  "leaves": ["0x1a2b3c4d...", "0x0000000000...", "..."],
  "tree": {
    "level0": ["0x1a2b3c4d...", "..."],
    "level1": ["0x2b3c4d5e...", "..."],
    "level2": ["0x3c4d5e6f...", "..."],
    "level3": ["0x4d5e6f70...", "..."],
    "level4": ["0x5e6f7081...", "..."],
    "level5": ["0x6f708192...", "..."],
    "level6": ["0x708192a3...", "..."],
    "level7": ["0x8192a3b4...", "..."],
    "level8": ["0xabcd1234efgh5678..."]
  },
  "generatedAt": 1704067200000
}
```

## 9. セキュリティ要求
### 9.1 ローカルセキュリティ
- **SEC‑01**: **ファイル暗号化**: 学生データの AES-256 暗号化
- **SEC‑02**: **アクセス制御**: OS ファイルシステム権限による保護
- **SEC‑03**: **監査ログ**: 全操作の改竄検知付きローカルログ
- **SEC‑04**: **データ検証**: インポート時の厳格な形式・整合性チェック

### 9.2 プライバシー保護
- **SEC‑05**: **ローカル処理**: 学生データの外部送信禁止
- **SEC‑06**: **最小権限**: 必要最小限のシステム権限使用
- **SEC‑07**: **一時ファイル**: 処理中データの安全な削除
- **SEC‑08**: **メモリ保護**: 機密データのメモリクリア

### 9.3 Trust Minimization
- **SEC‑09**: **外部依存排除**: データベース・クラウド・API 使用禁止
- **SEC‑10**: **検証可能性**: 全処理結果の暗号学的検証
- **SEC‑11**: **透明性**: オープンソース・監査可能な実装
- **SEC‑12**: **単一責任**: 明確な機能境界・最小攻撃面

## 10. ユーザビリティ要求
### 10.1 直感的操作
- **UX‑01**: **ドラッグ&ドロップ**: ファイルインポートの簡単操作
- **UX‑02**: **プログレス表示**: リアルタイム進捗・残り時間表示
- **UX‑03**: **エラーガイド**: 具体的エラー内容・解決方法表示
- **UX‑04**: **操作取消**: 重要操作の確認ダイアログ・取消機能

### 10.2 効率的ワークフロー
- **UX‑05**: **バッチ処理**: 全学生データの一括処理機能
- **UX‑06**: **テンプレート**: 証明書レイアウトの保存・再利用
- **UX‑07**: **自動バックアップ**: 操作完了時の自動バックアップ
- **UX‑08**: **検索・フィルタ**: 学生データの高速検索・絞込み

## 11. Tauri アプリ要求
### 11.1 デスクトップ統合
- **DESK‑01**: **ネイティブUI**: OS 標準のファイルダイアログ・通知
- **DESK‑02**: **システム統合**: ファイル関連付け・右クリックメニュー
- **DESK‑03**: **マルチウィンドウ**: 複数年度の並行作業対応
- **DESK‑04**: **自動更新**: 署名検証付きセキュアアップデート

### 11.2 セキュア Tauri
- **DESK‑05**: **サンドボックス**: 適切なセキュリティ設定
- **DESK‑06**: **IPC セキュリティ**: Main・Renderer 間の安全通信
- **DESK‑07**: **CSP 適用**: Content Security Policy 厳格設定
- **DESK‑08**: **Node.js 分離**: レンダラーでの Node.js 無効化

## 12. 受入基準
### 12.1 機能受入基準
- [ ] 全機能要求 (FR‑RC‑01 ~ FR‑RC‑07) の完全実装
- [ ] 3つの主要ユースケース (UC‑RC‑01~03) の正常動作
- [ ] 256学生データでの End-to-End テスト成功
- [ ] 年度別独立動作・データ分離の確認

### 12.2 性能受入基準
- [ ] Merkle Tree 構築 ≤ 10秒 (256学生)
- [ ] PDF バッチ生成 ≤ 2分 (256学生)
- [ ] アプリ起動時間 ≤ 3秒
- [ ] ファイル操作レスポンス ≤ 1秒

### 12.3 セキュリティ受入基準
- [ ] 外部ネットワーク通信 0件 確認
- [ ] ファイル暗号化・復号化 正常動作
- [ ] データ整合性検証 100% 成功
- [ ] 静的セキュリティ解析クリア

### 12.4 ユーザビリティ受入基準
- [ ] 初回ユーザーのタスク完了率 ≥ 95%
- [ ] エラー回復・ガイダンス機能確認
- [ ] アクセシビリティ (WAI-ARIA) 準拠
- [ ] 多言語対応 (日本語・英語)

## 13. 制約・依存関係
### 13.1 技術制約
- **Tauri**: 2.0+ (セキュリティ対応版)
- **Node.js**: 18+ LTS (Poseidon・PDF ライブラリ互換)
- **ストレージ**: 10GB以上 (年度データ・PDF保存)
- **メモリ**: 8GB以上 (大量PDF生成・Merkle Tree処理)

### 13.2 運用制約
- **年度切替**: 各年度開始前のデータ移行・設定更新
- **テンプレート管理**: 証明書レイアウトの年度別カスタマイズ
- **バックアップ運用**: 定期的な USB・外部ストレージ保存

### 13.3 法的制約
- **データ保護**: 個人情報保護法・大学規則準拠
- **文書保存**: 証明書発行記録の法定保存期間対応
- **監査要求**: 文部科学省・認証機関の監査対応

## 14. リスク・対策
| リスク ID | リスク内容 | 影響度 | 対策 |
|-----------|------------|--------|------|
| **R‑RC‑01** | 大量学生データ処理時のメモリ不足 | 中 | ストリーミング処理・段階的読込み |
| **R‑RC‑02** | PDF 生成ライブラリの脆弱性 | 高 | 定期更新・代替ライブラリ準備 |
| **R‑RC‑03** | ローカルファイル破損・消失 | 高 | 自動バックアップ・冗長化 |
| **R‑RC‑04** | Tauri セキュリティ問題 | 高 | 定期アップデート・セキュリティ監視 |
| **R‑RC‑05** | 年度データ移行時の操作ミス | 中 | 確認ダイアログ・操作ログ・復元機能 |

---

