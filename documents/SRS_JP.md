# ソフトウェア要件定義書 (SRS) — Tri-CertFramework（三層認証書類真正性証明システム）
**版 2.3  最終更新: 2025‑07‑10**

---

## 1. 目的
本書では、**Trust Minimized・完全バックエンドレス**な三層認証書類真正性証明システムを定義する。あらゆる書類に適応可能な設計で、例として卒業証書の真正性証明を実装。学生がCircom回路とSnarkJSを使用して時限付きゼロ知識証明を生成し、パスキーで電子署名を付与、**Ledger Nano X ハードウェアセキュリティ**による責任者操作を実現する。検証者はPDFファイル、Polygon zkEVMオンチェーンデータ、公開検証鍵リポジトリによる三層認証で真正性を確認できる。

## 2. スコープ
### 含まれる
* **証明者システム (Scholar Prover PWA)**: パスキー電子署名 + 検証鍵エクスポート + Circom/SnarkJS証明生成 + PDF/A‑3埋め込み
* **責任者システム (Executive Console Tauri)**: Ledger保護による年度回路デプロイ + VK管理
* **管理者システム (Registrar Console Tauri)**: 検証鍵レジストリ管理 + IPFS/GitHub公開 + Merkle tree + PDF一括生成
* **検証者システム (Verifier UI SSG)**: SnarkJS + 電子署名検証 + オンチェーンVK検証による三層認証
* **年度別独立性**: 書類発行年度間（2025, 2026等）の完全分離

### 含まれない
* バックエンドサーバーまたはデータベース
* 中央集権的クラウドサービス（AWS、Azure等）
* プライベートストレージサービス
* モバイルネイティブアプリケーション
* 複雑なキーローテーション仕組み
* 年度間依存関係

## 3. 用語定義
| 用語 | 定義 |
|------|------|
| **Passkey** | WebAuthn/FIDO2資格情報（ES‑256）による電子署名 |
| **Digital Signature** | ES256による文書ハッシュ電子署名 |
| **Verification Key** | JWK形式の公開鍵（電子署名検証用） |
| **Key Registry** | 検証鍵の公開リポジトリ（IPFS/GitHub） |
| **Commit** | Poseidon256(verification_key) → 32 bytes |
| **YearlySet** | 各卒業年度向けの独立した回路 + VK + NFT |
| **Proof** | Circom/SnarkJS Groth16証明、~2KB JSON |
| **Ledger EIP-191** | 管理者認証用ハードウェア署名パーソナルメッセージ |
| **Trust Minimization** | 公開ブロックチェーン・公開リポジトリ以外の外部依存性最小化 |

## 4. 利害関係者と関心事
* **学生（書類所有者）** – 検証可能な三層認証書類生成；ガス代なし、CLI不要、ブラウザのみ体験
* **責任者** – Ledger Nano X使用による年度回路デプロイ；最小セットアップ複雑性
* **管理者（登録係）** – 検証鍵レジストリ管理；IPFS/GitHub公開；一括PDF生成
* **検証者** – PDFドラッグ&ドロップで即座にオフライン三層認証検証
* **ブロックチェーン（Polygon zkEVM）** – 年度NFT保存；公開検証可能性提供
* **公開リポジトリ（IPFS/GitHub）** – 検証鍵配布；分散型公開アクセス

## 5. 4システム・アーキテクチャ

### 5.1 証明者システム（学生インターフェース）
- **タイプ**: Progressive Web App (PWA)
- **目的**: 電子署名生成・検証鍵エクスポート・ZKP生成・PDF埋め込み
- **ストレージ**: ブラウザlocalStorage + IndexedDB
- **依存性**: WebAuthn + Circom WASM + pdf-lib + JWK

### 5.2 責任者システム（責任者インターフェース）
- **タイプ**: Tauriデスクトップアプリケーション
- **目的**: Ledgerセキュリティによる年度回路デプロイ
- **ストレージ**: ローカルJSONファイル + 回路ファイル
- **依存性**: Ledger Nano X + Web3 + Circomコンパイラー

### 5.3 管理者システム（管理者インターフェース）
- **タイプ**: Tauriデスクトップアプリケーション
- **目的**: 検証鍵レジストリ管理 + IPFS/GitHub公開 + PDF生成
- **ストレージ**: ローカルJSONファイル + 生成PDF + 公開リポジトリ
- **依存性**: Poseidonハッシュ + PDF生成ライブラリ + IPFS/GitHub API

### 5.4 検証者システム（検証者インターフェース）
- **タイプ**: 静的サイト（Next.js 15 SSG + App Router）
- **目的**: 三層認証書類検証（ZKP + ブロックチェーン + 電子署名）
- **ストレージ**: 永続ストレージなし
- **依存性**: SnarkJS検証 + Web Crypto API + Polygon zkEVM RPC + IPFS/GitHub API

## 6. ユースケース概要
1. **UC‑01 学生電子署名キー生成・検証鍵エクスポート**（証明者システム）
2. **UC‑02 年度回路デプロイ**（責任者システム + Ledger）
3. **UC‑03 検証鍵レジストリ構築・IPFS/GitHub公開**（管理者システム）
4. **UC‑04 ZKP生成・電子署名・PDF埋め込み**（証明者システム）
5. **UC‑05 三層認証書類検証**（検証者システム）

## 7. 機能要求
| ID | 要求 | 実装 | 適合基準（TestID） |
|----|------|------|------------------|
| FR‑01 | システムはSnarkJS `proof.json`と電子署名をPDF/A‑3に埋め込むこと | 証明者システム | TC‑P01 |
| FR‑02 | 証明はCircom回路内でES‑256署名とMerkle包含を検証すること | 全回路 | TC‑P02 |
| FR‑03 | `expireTs < now()`時に証明は期限切れとなること | 検証者システム | TC‑N03 |
| FR‑04 | 検証者はYearNFTを照会し`vkHash`不一致時は拒否すること | 検証者システム | TC‑N04 |
| FR‑05 | 全責任者操作はLedger Nano X EIP-191署名を要求すること | 責任者システム | TC‑P05 |
| FR‑06 | 各書類発行年度は完全に独立していること | 全システム | TC‑P06 |
| FR‑07 | システムはバックエンドサーバーなしで動作すること | アーキテクチャ | TC‑P07 |
| FR‑08 | 学生は検証鍵をJWK形式でエクスポートできること | 証明者システム | TC‑P08 |
| FR‑09 | 管理者は検証鍵レジストリをIPFS/GitHubに公開できること | 管理者システム | TC‑P09 |
| FR‑10 | 検証者は公開リポジトリから検証鍵を取得できること | 検証者システム | TC‑P10 |
| FR‑11 | 検証者は電子署名を検証できること | 検証者システム | TC‑P11 |

## 8. 非機能要求
| 分類 | 指標 | 目標 | 備考 |
|----|------|------|------|
| 性能 | Circom証明生成 | ≤ 10s @ M1/1‑core | SnarkJS WASM最適化 |
| 性能 | SnarkJS検証 | ≤ 100ms | ブラウザWASM |
| 性能 | 電子署名生成 | ≤ 1s | WebAuthn API |
| 性能 | 電子署名検証 | ≤ 50ms | Web Crypto API |
| セキュリティ | 量子耐性 | SHA‑3‑512ハッシュ | 256ビット耐量子セキュリティ |
| セキュリティ | ハードウェアセキュリティ | Ledger Nano X必須 | EIP-191パーソナルメッセージ署名 |
| UX | オフライン検証 | ZKPのみ100%エアギャップ | 電子署名は検証鍵取得必要 |
| Trust | 外部依存性 | 公開チェーン・公開リポジトリのみ | 中央集権サービスゼロ |
| ストレージ | ローカルファイル制限 | <100MB/年 | 回路 + キーファイル |

## 9. セキュリティ要求

### 9.1 Trust Minimization原則
| 原則 | 実装 |
|------|------|
| **サーバーなし** | 全システムはローカル実行（Tauri/PWA/SSG） |
| **データベースなし** | JSONファイル + ブラウザストレージのみ |
| **最小外部サービス** | 公開ブロックチェーン + 公開リポジトリのみ |
| **ハードウェアセキュリティ** | 全責任者操作にLedger Nano X |
| **年度別独立性** | 年度間共有秘密なし |

### 9.2 EIP-191セキュリティ実装
```
ドメイン: "zk-cert-framework.local"
メッセージ構造:
- 操作タイプ (deploy_yearly_set, etc.)
- タイムスタンプ（5分間有効ウィンドウ）
- Nonce（リプレイ攻撃防止）
- 年度と回路パラメータ
- ユーザー検証用警告メッセージ
```

## 10. 受入基準
- 全重要テストケース（TC‑P01…TC‑P07）が複数ブラウザで合格
- Ledger Nano X統合がWindows/macOS/Linuxで動作
- 完全エアギャップ検証が成功
- 年度回路デプロイが独立NFTコントラクトを作成
- ネットワーク監視で外部サービス呼び出しゼロを検出
- Tauriアプリが単一実行ファイルにビルド

## 11. 制約
- **ハードウェア**: 責任者システムにLedger Nano X必須
- **ブラウザ**: Chrome 111+/Edge 111+/Safari 16.4+（WebAuthn Level 2）
- **ネットワーク**: Polygon zkEVM（本番環境用メインネット、テスト用Cardona）
- **ファイルサイズ**: 回路ファイル<50MB、証明ファイル<5MB
- **年度制限**: 書類発行年度あたり最大10,000名書類所有者

## 12. リスク管理
| ID | リスク | 確率 | 影響 | 軽減策 |
|----|------|------|------|-------|
| R‑1 | Passkeyデバイス紛失 | 中 | 高 | 再登録フロー + Merkleルート更新 |
| R‑2 | Ledgerサプライチェーン攻撃 | 低 | 重大 | ファームウェア検証 + 安全配送 |
| R‑3 | Circom回路バグ | 中 | 高 | 形式検証 + 広範囲テスト |
| R‑4 | ブラウザ互換性 | 低 | 中 | 機能検出 + グレースフル劣化 |
| R‑5 | Polygon zkEVM停止 | 低 | 中 | ローカル検証モード + RPCフォールバック |

## 13. コンプライアンスと標準
- **PDF**: ISO 32000-2（PDF 2.0）+ ISO 19005-3（PDF/A-3）
- **暗号**: FIPS 186-4（ES-256）、NIST SP 800-185（SHA-3）
- **WebAuthn**: W3C Web Authentication Level 2
- **ZKP**: Groth16（標準化済み）+ Powers of Tauセレモニー
- **EIP**: EIP-191（Ethereumパーソナルメッセージ署名）
